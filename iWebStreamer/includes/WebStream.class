<?

	require_once(dirname(__FILE__).'/WebStreamFile.class');

	class WebStream{
	
		var $webStreamId = '';
		var $name = '';
		var $idCount = 0;
		var $isValid=false;
		
		var $webStreamFileArr=array();
		
		function WebStream($webStreamId, $name){
			if($this->setWebStreamId($webStreamId)&&
			$this->setName($name)){
				$this->isValid=true;
			}else{
				$this->isValid=false;
			}
		}
		
		function getWebStreamId(){
			return $this->webStreamId;
		}
		
		function getName(){
			return $this->name;
		}
		
		function getIsValid(){
			return $this->isValid;
		}
		
		function getWebStreamFileArr(){
			return $this->webStreamFileArr;
		}
		
		function getWebStreamFileObj($webStreamFileId){
			if(is_object($this->webStreamFileArr[$webStreamFileId])){
				return $this->webStreamFileArr[$webStreamFileId];
			}else{
				return false;
			}
		}
		
		function getSortedWebStreamFileArr(){
			$sortedArr=$this->getWebStreamFileArr();
			$result=asort($sortedArr);
			if($result){
				return $sortedArr;
			}else{
				//sorting failed
				return false;
			}
		}
		
		function getReverseSortedWebStreamFileArr(){
			$reverseSortedArr=$this->getWebStreamFileArr();
			$result=arsort($reverseSortedArr);
			if($result){
				return $reverseSortedArr;
			}else{
				//sorting failed
				return false;
			}
		}
		
		//returns an array of available player types
		function getAvailableTypes(){
			$availableTypesArr=array();
			if ($handle = opendir(FLASHPLAYERSROOTFULLPATH)) {
   				while (false !== ($file = readdir($handle))) {
       					if ($file != "." && $file != "..") {
           					array_push($availableTypesArr, $file);
       					}
   				}
   				closedir($handle);
			}else{
				global $iWebStreamerErrorObj;
				$iWebStreamerErrorObj->registerCritical('Unable to open available types directory.');
			}
			return $availableTypesArr;
		}
		
		//convention:
		// FLASHPLAYERSROOTFULLPATH/type/playerColor.swf
		function getAvailableColors($type){
			$availableColorsArr=array();
			if ($handle = opendir(FLASHPLAYERSROOTFULLPATH.'/'.$type)) {
   				while (false !== ($file = readdir($handle))) {
       					if ($file != "." && $file != "..") {
						$file=trim($file);
						if(preg_match('/\.swf$/', $file)&&preg_match('/^player/', $file)){
							$tmpFileSplit=preg_split('/player/', $file);
           						$tmpFileSplit2=preg_split('/\.swf/', $tmpFileSplit[1]);
							$color=trim($tmpFileSplit2[0]);
							if(!preg_match('/^Default$/', $color)){
								array_push($availableColorsArr, $color);
							}
						}
       					}
   				}
   				closedir($handle);
			}else{
				global $iWebStreamerErrorObj;
				$iWebStreamerErrorObj->registerCritical('Unable to open available colors directory.');
			}
			return $availableColorsArr;
		}
		
		function getFlashPlayerCode($type, $color, $autoplay=false, $divTitle=false, $repeat_playlist=false){
		
		/*
		
			global $width, $height, $version;
		
			if(!$divTitle){
				$divTitle='flashcontent';
			}
			
			$divTitle=rand();
			
			require_once(FLASHPLAYERSROOTFULLPATH."/".$type."/dimensions.inc");
		
			$returnStr="<!-- Begin code generated by iWebStreamer - Playlist = ".$this->getName()." -->\n";
			$returnStr.="<div id='$divTitle'>You need at least flash plugin version $version.\n";
			$returnStr.=" Click <a href='http://www.macromedia.com/go/getflashplayer' target='_blank'>here</a>\n";
			$returnStr.="to install.\n";
			$returnStr.=" Once installed, you may need to restart your browser.\n";
			$returnStr.="</div>\n\n";
			$returnStr.="<script type='text/javascript' src='/iWebStreamer-UserWeb/flash/flashobject.js'>\n";
			$returnStr.="</script>\n\n";
			$returnStr.="<!--[if IE]><script defer src='/iWebStreamer-UserWeb/flash/ie_onload.js'></script><![endif]-->\n\n";
			$returnStr.="<script type='text/javascript'>\n";
			$returnStr.="\tvar flashObjectArg1 = 'http://' + document.domain\n";
			$returnStr.="\tflashObjectArg1 = flashObjectArg1 + '".FLASHPLAYERSROOT."';\n";
			$returnStr.="\tflashObjectArg1 = flashObjectArg1 + '/".$type."/player".$color.".swf';\n";
			$returnStr.="\tflashObjectArg1 = flashObjectArg1 + '?playlist_url=http://' + document.domain;\n";
			$returnStr.="\tflashObjectArg1 = flashObjectArg1 + '/cgi-sys/iWebStreamer/playlist.xspf';\n";
			$returnStr.="\tflashObjectArg1 = flashObjectArg1 + '?webStreamId=".$this->getWebStreamId()."';\n";
			
			if($autoplay){
				$returnStr.="\tflashObjectArg1 = flashObjectArg1 +'&autoplay=true';\n";
			}
			
			if($repeat_playlist){
				$returnStr.="\tflashObjectArg1 = flashObjectArg1 +'&repeat_playlist=true';\n";
			}
			
			$returnStr.="\tvar fo = new FlashObject(flashObjectArg1, 'mymovie', '$width', '$height', '$version', '');\n";
			
			$returnStr.="\tfo.addParam('allowScriptAcces', 'sameDomain');\n";
			$returnStr.="\tfo.addParam('quality', 'high');\n";
			$returnStr.="\tfo.addParam('xn_auth', 'no');\n";
			
   			$returnStr.="if(navigator.appName != 'Microsoft Internet Explorer'){\n";
			$returnStr.="\tfo.write('$divTitle');\n";
			$returnStr.="}\n";
	
			$returnStr.="function customOnLoad(){\n";
			$returnStr.="\tfo.write('$divTitle');\n";
			$returnStr.="}\n";
			
			$returnStr.="</script>\n";
			$returnStr.="<!-- End code generated by iWebStreamer - Playlist = ".$this->getName()." -->";
			
			return($returnStr);
			*/
			
			//----new function below
			global $width, $height, $version;
			require_once(FLASHPLAYERSROOTFULLPATH."/".$type."/dimensions.inc");
			
			
				//generate a random div title
				$acceptedChars = 'azertyuiopqsdfghjklmwxcvbnAZERTYUIOPQSDFGHJKLMWXCVBN';
  				$max = strlen($acceptedChars)-1;
  				$randDivName='';
  				for($i=0; $i < 8; $i++) {
   					$randDivName .= $acceptedChars{mt_rand(0, $max)};
				}
				
				$shockWaveFile=FLASHPLAYERSROOT.'/'.$type.'/player'.$color.'.swf';
				
			$returnStr="\n<!-- Begin code generated by iWebStreamer -->\n";
			$returnStr.="\t<script type='text/javascript' src='/iWebStreamer-UserWeb/flash/flashobject-helper.js'>\n";
			$returnStr.="\t</script>\n\n";
			$returnStr.="\t<script type='text/javascript'>\n";
			$returnStr.="\t<!--\n";
			$returnStr.="\t\tshockwavePath='$shockWaveFile';\n";
			$returnStr.="\t\twebStreamId=".$this->getWebStreamId().";\n";
			
			if($autoplay){
				$returnStr.="\t\tautoplay = true;\n";
			}else{
				$returnStr.="\t\tautoplay = false;\n";
			}
			if($repeat_playlist){
				$returnStr.="\t\trepeat_playlist=true;\n";
			}else{
				$returnStr.="\t\trepeat_playlist=false;\n";
			}
			
			$returnStr.="\t\tplayerWidth='$width';\n";
			$returnStr.="\t\tplayerHeight='$height';\n";
			$returnStr.="\t\tplayerVersion='$version';\n";
			
			$returnStr.="\t\tcreateWebStreamCode('$randDivName',shockwavePath,webStreamId,autoplay,\r\t\t";
			$returnStr.="repeat_playlist,playerWidth,playerHeight,playerVersion);\n";
			$returnStr.="\t//-->\n";
			$returnStr.="\t</script>\n";
			$returnStr.="<!-- End code generated by iWebStreamer -->\n";
			
			return($returnStr);
		}
		
		function getDefaultPlayerCode($type, $autoplay=false){
			return $this->getFlashPlayerCode($type, 'Default', $autoplay, $type);
		}
		
		function addWebStreamFile($fileId, $isRFAudio){
			
			$webStreamFile=new WebStreamFile($this->idCount, $fileId, $isRFAudio);
			if($webStreamFile->getIsValid()){
				$this->webStreamFileArr[$this->idCount]=$webStreamFile;
				$this->idCount++;
				return true;
			}else{
				return false;
			}
		}
		
		function removeWebStreamFile($webStreamFileId){
			$newWebStreamFileArr=array();
			foreach($this->getWebStreamFileArr() as $thisWebStreamFileId => $thisWebStreamFileObj){
				if($webStreamFileId != $thisWebStreamFileId){
					$newWebStreamFileArr[$thisWebStreamFileId]=$thisWebStreamFileObj;
				}
			}
			$this->webStreamFileArr=$newWebStreamFileArr;
		}
		
		
		function setWebStreamId($webStreamId){
			if(is_int($webStreamId)){
				$this->webStreamId=$webStreamId;
				return true;
			}else{
				return false;
			}
		}
		
		function setName($name){
			$this->name=$name;
			return true;
		}
		
	}

?>